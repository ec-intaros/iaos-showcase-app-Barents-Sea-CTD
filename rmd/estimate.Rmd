---
title: "INTAROS - IMR Dataset - Estimation workflow"
author: "D. Renard, F. Ors"
date: "January 22nd 2019"
output:
  pdf_document: default
  html_document: default
---

# Introduction

This paper is meant to demonstrate how to implement an unitary workflow by (i) downloading data from IMR OpenDAP server and (ii) estimate the Temperature variable using **RGeostats** package. The different paths must be adapted according the system which is running this script.

# Download data and create a CSV file

First of all, we define the filtering parameters and then we launch the **download_data.py** Python command.

```{r Download data, message = FALSE, warning = FALSE}
# Paths to resources
csv_file = file.path(getwd(),"data/data.csv")
python = "/opt/anaconda/bin/python"
pydown = file.path(getwd(),"lib","download_data.py")

# Filtering parameters
date_lim = c("2001/04/01","2001/06/30")
long_lim = c(-2,10)
lat_lim = c(57,63)
depth_lim = c(18,22)

# Build Python command
downcmd = paste(python, pydown,
                "--data_file", csv_file,
                "--long_lim",  paste(long_lim,  collapse=" "),
                "--lat_lim",   paste(lat_lim,   collapse=" "),
                "--depth_lim", paste(depth_lim, collapse=" "),
                "--date_lim",  paste(date_lim,  collapse=" "),
                "--verbose 1 --show_time 0",
                sep=" ")

# Download filtered data and create CSV file
cat(paste("Executing:",downcmd,"\n",sep=" "))
output = system(downcmd)
cat("Command output:<",output,">\n")
```

# Estimate the Temperature variable from downloaded data

Then estimate the Temperature variable by calling the **estimate.R** R script.

```{r Loading data, message = FALSE, warning = FALSE}
# Path to resources
csv_file = file.path(getwd(),"data/data.csv")
restimate = file.path(getwd(),"lib","estimate.R")

# Additional Estimation parameters
var = "Temperature"
var_lim = c(1,10)
mesh = 0.1
vario_lag = 0.1
vario_nlag = 20
struct = c(1,3,12)

# Override commandArgs function for sourcing the estimate.R script
commandArgs <- function(...)
{
    c(csv_file,
      paste(date_lim,  collapse=","),
      paste(long_lim,  collapse=","),
      paste(lat_lim,   collapse=","),
      paste(depth_lim, collapse=","),
      var,
      paste(var_lim,   collapse=","),
      mesh,
      vario_lag,
      vario_nlag,
      paste(struct,    collapse=","))
}

# Estimate
source(restimate)
```
